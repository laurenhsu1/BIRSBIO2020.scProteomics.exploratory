<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. Tumor spatial autocorrelation and clinical prognosis • BIRSBIO2020.scProteomics.exploratory</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. Tumor spatial autocorrelation and clinical prognosis">
<meta property="og:description" content="BIRSBIO2020.scProteomics.exploratory">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020.scProteomics.exploratory</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/celltypes_RF.html">1. Transferring cell type labels</a>
    </li>
    <li>
      <a href="../articles/compute_morans.html">Compute Moran's Index</a>
    </li>
    <li>
      <a href="../articles/moran_clinical.html">2. Tumor spatial autocorrelation and clinical prognosis</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://laurenhsu1.github.io/BIRSBIO2020.scProteomics.exploratory">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="moran_clinical_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2. Tumor spatial autocorrelation and clinical prognosis</h1>
                        <h4 class="author">Lauren Hsu<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/laurenhsu1/BIRSBIO2020.scProteomics.exploratory/blob/master/vignettes/moran_clinical.Rmd"><code>vignettes/moran_clinical.Rmd</code></a></small>
      <div class="hidden name"><code>moran_clinical.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In this vignette, I examine the Moran’s index and its associations to the clinically prognostic tumor categories set forth by the authors in <a href="https://pubmed.ncbi.nlm.nih.gov/30193111/"><em>A Structured Tumor-Immune Microenvironment in Triple Negative Breast Cancer Revealed by Multiplexed Ion Beam Imaging</em></a>.</p>
<p><img src="imgs/morans/keren_dataintro.png" style="width:95.0%"></p>
<p>Visit the <a href="https://github.com/BIRSBiointegration/Hackathon">BIRSBiointegration Hackathon page</a> to read more about MIBI-TOF.</p>
<p><img src="imgs/morans/spatial_autocorr.png" style="width:95.0%"></p>
<p><img src="imgs/morans/morans_cartoon.png" style="width:95.0%"><img src="imgs/morans/moran_explainer.png" style="width:95.0%"></p>
</div>
<div id="loading-data" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-data" class="anchor"></a>Loading data</h1>
<p><em>resMoranTest.csv</em> is the output from running <strong>compute_morans.R</strong> on the mibiTOF segmented image files, downloadable here: <a href="https://www.angelolab.com/mibi-data" class="uri">https://www.angelolab.com/mibi-data</a></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">datpath</span> <span class="kw">&lt;-</span> <span class="st">'../data'</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">datpath</span>, <span class="st">'moranRes.rda'</span>))</pre></body></html></div>
<p>A key component used in computing Moran’s I is the spatial weighting matrix (SWM). This can be formed from any number of ways, including by various distance metrics (e.g., Euclidean), by graphs, or any other ways of defining proximity in space.</p>
<p><img src="imgs/morans/swm.png" style="width:95.0%"></p>
<p>We used SWM defined by Gabriel neighborhoods, which is a special case of a Delaunay graph (constructed from Voronoi tesselation). Delaunay graphs are constructed by drawing edges between all nodes with shared Voronoi faces (light blue edges and yellow nodes on the bottom right below). To then transform the graph into a Gabriel graph, edges are pruned if there are other points that lie within the smallest circle passing through those two points (e.g., in the red circles below), and edges are kept if not (e.g., in the green circle below).</p>
<p><img src="imgs/morans/gabriel_graph.png" style="width:95.0%"></p>
<p><em>patient_class.csv</em> is included in the download from the link above. For each sample it contains the tumor classification as defined in the paper:</p>
<p><img src="imgs/morans/tumor_classes.png" style="width:95.0%"></p>
</div>
<div id="moran-plots" class="section level1">
<h1 class="hasAnchor">
<a href="#moran-plots" class="anchor"></a>Moran plots</h1>
<p>Computing p-values for 3-way ANOVA test of significance for Moran’s I on the dummy variables (cell type flags) and each protein expression level.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">moran_aov</span> <span class="kw">&lt;-</span> <span class="no">moran</span>[,-<span class="fl">1</span>]
<span class="no">moran_aov</span>$<span class="no">class</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">moran_aov</span>$<span class="no">class</span>)

<span class="no">feats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">moran_aov</span>)[-<span class="fl">42</span>]

<span class="no">pvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">NA</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">feats</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">pvals</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'feat'</span>,<span class="st">'aov_pval'</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals</span>) <span class="kw">&lt;-</span> <span class="no">feats</span>

<span class="kw">for</span> (<span class="no">feat</span> <span class="kw">in</span> <span class="no">feats</span>){
  <span class="no">pvals</span>[<span class="no">feat</span>,] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">feat</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(<span class="no">moran_aov</span>[,<span class="no">feat</span>] ~ <span class="no">moran_aov</span>[,<span class="st">'class'</span>]))<span class="kw">[[</span><span class="fl">1</span>]]<span class="kw">[[</span><span class="st">'Pr(&gt;F)'</span>]][<span class="fl">1</span>])
}

<span class="no">pvals</span>$<span class="no">aov_pval</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">pvals</span>$<span class="no">aov_pval</span>)

<span class="no">pvals</span> <span class="kw">&lt;-</span> <span class="no">pvals</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">pvals</span>$<span class="no">aov_pval</span>),]</pre></body></html></div>
<p>Individual ANOVA tests: (3 sets; for each, the other 2 groups are coded together as “other”)</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">moran_aov_sep</span> <span class="kw">&lt;-</span> <span class="no">moran</span>[,-<span class="fl">1</span>]
<span class="no">moran_aov_sep</span>$<span class="no">class_cold</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw pkg">plyr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>(<span class="no">moran_aov_sep</span>$<span class="no">class</span>,
                               <span class="kw">from</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'mixed'</span>,<span class="st">'compartment'</span>,<span class="st">'cold'</span>),
                               <span class="kw">to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'other'</span>,<span class="st">'other'</span>,<span class="st">'cold'</span>)))
<span class="no">moran_aov_sep</span>$<span class="no">class_mixed</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw pkg">plyr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>(<span class="no">moran_aov_sep</span>$<span class="no">class</span>,
                               <span class="kw">from</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'mixed'</span>,<span class="st">'compartment'</span>,<span class="st">'cold'</span>),
                               <span class="kw">to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'mixed'</span>,<span class="st">'other'</span>,<span class="st">'other'</span>)))
<span class="no">moran_aov_sep</span>$<span class="no">class_comp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw pkg">plyr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>(<span class="no">moran_aov_sep</span>$<span class="no">class</span>,
                               <span class="kw">from</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'mixed'</span>,<span class="st">'compartment'</span>,<span class="st">'cold'</span>),
                               <span class="kw">to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'other'</span>,<span class="st">'compartment'</span>,<span class="st">'other'</span>)))

<span class="no">feats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">moran_aov_sep</span>)[<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">45</span>:-<span class="fl">42</span>)]

<span class="no">pvals_sep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">NA</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">feats</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">pvals_sep</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'feat'</span>,<span class="st">'test_cold'</span>,<span class="st">'test_mixed'</span>,<span class="st">'test_comp'</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals_sep</span>) <span class="kw">&lt;-</span> <span class="no">feats</span>

<span class="kw">for</span> (<span class="no">feat</span> <span class="kw">in</span> <span class="no">feats</span>){
  <span class="no">pvals_sep</span>[<span class="no">feat</span>,] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">feat</span>,
                        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(<span class="no">moran_aov_sep</span>[,<span class="no">feat</span>] ~ <span class="no">moran_aov_sep</span>[,<span class="st">'class_cold'</span>]))<span class="kw">[[</span><span class="fl">1</span>]]<span class="kw">[[</span><span class="st">'Pr(&gt;F)'</span>]][<span class="fl">1</span>],
                        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(<span class="no">moran_aov_sep</span>[,<span class="no">feat</span>] ~ <span class="no">moran_aov_sep</span>[,<span class="st">'class_mixed'</span>]))<span class="kw">[[</span><span class="fl">1</span>]]<span class="kw">[[</span><span class="st">'Pr(&gt;F)'</span>]][<span class="fl">1</span>],
                        <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span>(<span class="no">moran_aov_sep</span>[,<span class="no">feat</span>] ~ <span class="no">moran_aov_sep</span>[,<span class="st">'class_comp'</span>]))<span class="kw">[[</span><span class="fl">1</span>]]<span class="kw">[[</span><span class="st">'Pr(&gt;F)'</span>]][<span class="fl">1</span>])
}

<span class="no">pvals_sep</span>[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals</span>),]</pre></body></html></div>
<pre><code>##                      feat           test_cold           test_mixed
## tumorYN           tumorYN  0.0341255910828547  0.00138488568677017
## CD45                 CD45 0.00926810561241914   0.0172991570917716
## CD45RO             CD45RO   0.153768342349517 0.000847841247869497
## CD11c               CD11c  0.0359573772907523   0.0106009334311595
## CD4                   CD4   0.272629983491842 0.000990523269478657
## Beta.catenin Beta.catenin   0.441713353948455 0.000633966876022113
## CSF.1R             CSF.1R  0.0260297339236067   0.0734092694590058
## CD3                   CD3   0.231378899113043  0.00606288943242979
## Pan.Keratin   Pan.Keratin   0.280025985796279  0.00733873289803587
## CD8                   CD8 0.00881687281664925       0.247950391012
## H3K9ac             H3K9ac 0.00768400905209691  0.00332980957925492
## HLA.DR             HLA.DR   0.721556225584227  0.00268378125355884
## PD.L1               PD.L1 0.00189108015255096    0.973256320059549
## PD1                   PD1   0.396163920509005    0.010541639052546
## Keratin6         Keratin6   0.191068629524341   0.0324436596735067
## CD11b               CD11b  0.0507890928320497    0.208960309971905
## Vimentin         Vimentin   0.157054785990441  0.00337777238568537
## CD20                 CD20   0.343906470528576   0.0202168392251092
## cellSize         cellSize   0.495024045383168   0.0224414424296167
## CD16                 CD16  0.0203026161959533    0.643303061732047
## CD163               CD163   0.774417327487516   0.0200755355846754
## CD138               CD138  0.0321922296600026   0.0670285683964105
## HLA_Class_1   HLA_Class_1   0.575185456376524   0.0152914905787428
## phospho.S6     phospho.S6   0.356008033837109   0.0204491896010629
## H3K27me3         H3K27me3   0.573476548037953   0.0252502986964708
## Keratin17       Keratin17    0.48333491261473   0.0264463023616048
## p53                   p53    0.02920027513594    0.621112186580165
## CD209               CD209   0.075665916309574    0.594684205683068
## OX40                 OX40   0.407556206139695    0.122410375469582
## CD31                 CD31   0.596672323390244   0.0946218569210861
## Lag3                 Lag3   0.972418703053599   0.0448862813916235
## B7H3                 B7H3  0.0524360558556027    0.387246616574369
## Ki67                 Ki67   0.928414429412843    0.128460352975178
## MPO                   MPO   0.230393392178348    0.587012118460728
## IDO                   IDO   0.980359448027047    0.177751252998018
## CD68                 CD68   0.200304931399538    0.799693019882516
## SMA                   SMA   0.381927436545846     0.27226501530817
## FoxP3               FoxP3   0.293454923929008    0.450073122721021
## CD63                 CD63   0.899182243125353    0.319317727598852
## CD56                 CD56   0.325289880739089    0.626169875408483
## EGFR                 EGFR   0.761672949319811    0.851555474947503
##                         test_comp
## tumorYN      5.01078563984276e-08
## CD45         2.97989056262974e-06
## CD45RO       1.13364321116951e-06
## CD11c        8.49490976222607e-06
## CD4          8.18904341534503e-06
## Beta.catenin 1.84599969895042e-05
## CSF.1R       0.000411883978663573
## CD3          0.000110353888557948
## Pan.Keratin   0.00022813542098335
## CD8           0.00252248271314348
## H3K9ac          0.232016396221856
## HLA.DR       0.000619848715663221
## PD.L1          0.0445801939992952
## PD1           0.00083481369919345
## Keratin6      0.00124082021354464
## CD11b         0.00749451883529667
## Vimentin       0.0473951787483856
## CD20          0.00352866245988334
## cellSize      0.00379811596789498
## CD16           0.0448972617394975
## CD163          0.0109454363422921
## CD138           0.627399123706833
## HLA_Class_1    0.0356832322421822
## phospho.S6     0.0822829730944162
## H3K27me3       0.0560420017774816
## Keratin17      0.0726084698341079
## p53             0.373008733951914
## CD209           0.105807280220194
## OX40           0.0338333250955215
## CD31           0.0348130551865471
## Lag3           0.0408842537259478
## B7H3            0.458033396966791
## Ki67           0.0979176465990246
## MPO             0.173574551750504
## IDO             0.166727117095437
## CD68            0.567440678482007
## SMA             0.579516983961658
## FoxP3           0.867616415535372
## CD63            0.344490529642514
## CD56            0.980073086236272
## EGFR            0.693654383426714</code></pre>
</div>
<div id="visualizing-morans-i-across-groups" class="section level1">
<h1 class="hasAnchor">
<a href="#visualizing-morans-i-across-groups" class="anchor"></a>Visualizing Moran’s I across groups</h1>
<p>Comparing Moran’s I scores across the clinical prognosis categories on the tumor cell dummy variable:</p>
<p>(Moran’s I is computed where the measurement in each cell is 1 or 0, for whether is is or is not a tumor cell, providing a measure of spatial autocorrelation of tumor cells within the sample.)</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="no">moran</span>, <span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">class</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">tumorYN</span>)) +
  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">class</span>))</pre></body></html></div>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Here, we can see the differences when visualized alongsidem images of the tumors (tumor images as published by Keren et al. 2018)</p>
<p><img src="imgs/morans/moran_boxplot_tumor.png" style="width:95.0%"></p>
<p>Comparing all attributes:</p>
<p>(Each panel corresponds to a given attribute, mostly proteins, and shows the differences in spatial autocorrelation, as quantified with Moran’s I, across the clinical groups. Panels are sorted by p-value of 3 way anova, and include <span style="color: red;">*</span>s to indicate their significance level in the “each vs rest” ANOVA tests.)</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">moran_melt</span> <span class="kw">&lt;-</span> <span class="fu">melt</span>(<span class="no">moran</span>,<span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'sample'</span>,<span class="st">'class'</span>))
<span class="no">moran_melt</span>$<span class="no">variable</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">moran_melt</span>$<span class="no">variable</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals</span>)) <span class="co"># sort panels by 3way anova pval</span>

<span class="no">mm</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>(<span class="no">moran_melt</span>, <span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">class</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>)) +
  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">class</span>)) + <span class="fu">facet_wrap</span>(<span class="no">.</span> ~ <span class="no">variable</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu">stat_compare_means</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"anova"</span>, <span class="kw">label.y</span> <span class="kw">=</span> <span class="fl">1.1</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +      <span class="co"># Add global p-value</span>
  <span class="fu">stat_compare_means</span>(<span class="kw">label</span> <span class="kw">=</span> <span class="st">"p.signif"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"t.test"</span>,
                     <span class="kw">ref.group</span> <span class="kw">=</span> <span class="st">".all."</span>, <span class="kw">hide.ns</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">'red'</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span><span class="kw">=</span><span class="fu">element_blank</span>(),
        <span class="kw">axis.ticks.x</span><span class="kw">=</span><span class="fu">element_blank</span>())</pre></body></html></div>
<p><img src="imgs/morans/morans_all.png" style="width:100.0%"></p>
<p>Defining some proteins that may be interesting to consider together, due to related cell types / function:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">immune_subset</span> <span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CD45'</span>,<span class="st">'CD45RO'</span>, <span class="st">'CD3'</span>,<span class="st">'CD8'</span>, <span class="st">'CD16'</span>,<span class="st">'CD163'</span>,<span class="st">'HLA.DR'</span>)
<span class="no">immune_subset2</span> <span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CD45'</span>,<span class="st">'CD45RO'</span>, <span class="st">'CD3'</span>,<span class="st">'CD8'</span>, <span class="st">'CD16'</span>,<span class="st">'CD163'</span>,<span class="st">'HLA.DR'</span>, <span class="st">'CD11c'</span>)
<span class="no">monocyte_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CD11b'</span>,<span class="st">'CD11c'</span>,<span class="st">'CD68'</span>,<span class="st">'CD63'</span>)
<span class="no">im_reg_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'PD1'</span>,<span class="st">'PD.L1'</span>)
<span class="no">tum_subset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'tumorYN'</span>, <span class="st">'Beta.catenin'</span>, <span class="st">'Pan.Keratin'</span>, <span class="st">'Keratin6'</span>, <span class="st">'EGFR'</span>, <span class="st">'p53'</span>)
<span class="no">lymphocytes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CD45'</span>,<span class="st">'CD3'</span>,<span class="st">'CD8'</span>,<span class="st">'CD4'</span>,<span class="st">'CD20'</span>,<span class="st">'CD45RO'</span>,<span class="st">'CD56'</span>,<span class="st">'CD16'</span>,<span class="st">'CD138'</span>)
<span class="no">antigen_prez</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'HLA.DR'</span>,<span class="st">'HLA_Class_1'</span>, <span class="st">'CD209'</span>)</pre></body></html></div>
<p>Examining a few of the protein subsets</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="kw">for</span>(<span class="no">cur_sub</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">immune_subset</span>, <span class="no">monocyte_subset</span>, <span class="no">tum_subset</span>, <span class="no">lymphocytes</span>, <span class="no">antigen_prez</span>)){
  <span class="no">moran_melt</span> <span class="kw">&lt;-</span> <span class="fu">melt</span>(<span class="no">moran</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'sample'</span>,<span class="st">'class'</span>,<span class="no">cur_sub</span>)],<span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'sample'</span>,<span class="st">'class'</span>))
  <span class="no">moran_melt</span>$<span class="no">variable</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">moran_melt</span>$<span class="no">variable</span>,
                                <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals</span>)[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">pvals</span>) <span class="kw">%in%</span> <span class="no">cur_sub</span>])
  <span class="co"># sort panels by 3way anova pval</span>

  <span class="fu">ggplot</span>(<span class="no">moran_melt</span>, <span class="fu">aes</span>(<span class="kw">x</span><span class="kw">=</span><span class="no">class</span>, <span class="kw">y</span><span class="kw">=</span><span class="no">value</span>)) +
    <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">class</span>)) + <span class="fu">facet_wrap</span>(<span class="no">.</span> ~ <span class="no">variable</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">5</span>) +
    <span class="fu">stat_compare_means</span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"anova"</span>, <span class="kw">label.y</span> <span class="kw">=</span> <span class="fl">1.1</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +      <span class="co"># Add global p-value</span>
    <span class="fu">stat_compare_means</span>(<span class="kw">label</span> <span class="kw">=</span> <span class="st">"p.signif"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"t.test"</span>,
                       <span class="kw">ref.group</span> <span class="kw">=</span> <span class="st">".all."</span>, <span class="kw">hide.ns</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">'red'</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>) +
    <span class="fu">theme</span>(<span class="kw">axis.text.x</span><span class="kw">=</span><span class="fu">element_blank</span>(),
          <span class="kw">axis.ticks.x</span><span class="kw">=</span><span class="fu">element_blank</span>())
  <span class="no">moranHM</span> <span class="kw">&lt;-</span> <span class="no">moran</span>[,-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">43</span>)]
  <span class="no">moranHM</span> <span class="kw">&lt;-</span> <span class="no">moranHM</span>[,<span class="no">cur_sub</span>]
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">moranHM</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">moran</span>$<span class="no">sample</span>,<span class="no">moran</span>$<span class="no">class</span>,<span class="kw">sep</span> <span class="kw">=</span> <span class="st">': '</span>)
  <span class="fu">show</span>(<span class="kw pkg">ComplexHeatmap</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(<span class="no">moranHM</span>))
}</pre></body></html></div>
<pre><code>## Warning: The input is a data frame, convert it to the matrix.

## Warning: The input is a data frame, convert it to the matrix.</code></pre>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<pre><code>## Warning: The input is a data frame, convert it to the matrix.</code></pre>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<pre><code>## Warning: The input is a data frame, convert it to the matrix.</code></pre>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-7-3.png" width="700"></p>
<pre><code>## Warning: The input is a data frame, convert it to the matrix.</code></pre>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-7-4.png" width="700"><img src="moran_clinical_files/figure-html/unnamed-chunk-7-5.png" width="700"></p>
</div>
<div id="additional-visualizations" class="section level1">
<h1 class="hasAnchor">
<a href="#additional-visualizations" class="anchor"></a>Additional visualizations</h1>
<p>Biplot: samples labeled by tumor class and proteins</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">moran_bip</span> <span class="kw">&lt;-</span> <span class="kw pkg">corral</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/corral/man/na2zero.html">na2zero</a></span>(<span class="no">moran_aov</span>[,-<span class="fl">42</span>])
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">moran_bip</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">moran</span>$<span class="no">sample</span>,<span class="no">moran</span>$<span class="no">class</span>,<span class="kw">sep</span> <span class="kw">=</span> <span class="st">': '</span>)
<span class="no">prc_moran</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span>(<span class="no">moran_bip</span>)
<span class="fu"><a href="https://rdrr.io/r/stats/biplot.html">biplot</a></span>(<span class="no">prc_moran</span>)</pre></body></html></div>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Heatmap of the Moran’s I values per protein, per sample.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">moranHM</span> <span class="kw">&lt;-</span> <span class="no">moran</span>[,-<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">43</span>)]
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">moranHM</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">moran</span>$<span class="no">sample</span>,<span class="no">moran</span>$<span class="no">class</span>,<span class="kw">sep</span> <span class="kw">=</span> <span class="st">': '</span>)
<span class="kw pkg">ComplexHeatmap</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(<span class="no">moranHM</span>)</pre></body></html></div>
<pre><code>## Warning: The input is a data frame, convert it to the matrix.</code></pre>
<p><img src="moran_clinical_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Harvard School of Public Health<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lauren Hsu, Aedin Culhane.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
