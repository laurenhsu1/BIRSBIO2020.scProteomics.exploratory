<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Transferring cell type labels • BIRSBIO2020.scProteomics.exploratory</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Transferring cell type labels">
<meta property="og:description" content="BIRSBIO2020.scProteomics.exploratory">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020.scProteomics.exploratory</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/celltypes_RF.html">1. Transferring cell type labels</a>
    </li>
    <li>
      <a href="../articles/compute_morans.html">Compute Moran's Index</a>
    </li>
    <li>
      <a href="../articles/moran_clinical.html">2. Tumor spatial autocorrelation and clinical prognosis</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://laurenhsu1.github.io/BIRSBIO2020.scProteomics.exploratory">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="celltypes_RF_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Transferring cell type labels</h1>
                        <h4 class="author">Lauren Hsu<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/laurenhsu1/BIRSBIO2020.scProteomics.exploratory/blob/master/vignettes/celltypes_RF.Rmd"><code>vignettes/celltypes_RF.Rmd</code></a></small>
      <div class="hidden name"><code>celltypes_RF.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><img src="imgs/rf/data_challenge.png" style="width:95.0%"></p>
<p>Visit the <a href="https://github.com/BIRSBiointegration/Hackathon">BIRSBiointegration Hackathon page</a> to read more about these datasets.</p>
<p>The MIBI-TOF dataset came annotated with cell type classifications, while the cyTOF datasets did not include them. As shown in the Venn diagram above, there is some overlap in markers measured across datasets, but still limited intersection.</p>
<p>The mibi-tof dataset comprised a single panel of 36 proteins.</p>
<p>The cytof datasets included data from two different panels, totalling 73 proteins. See the hackathon page linked above for a detailed description of the datasets.</p>
<p>In this vignette we examine the robustness of predictions between datasets, given limited overlap in shared markers.</p>
<p><img src="imgs/rf/prediction_strength.png" style="width:95.0%"></p>
<p>In total, we built three sets of random forest models:</p>
<ol start="0" style="list-style-type: decimal">
<li>Trained on <em>mibi data</em> using all the features captured in the mibi dataset, used to demonstrate the that within mibi alone, cell types can be predicted. We also expect this model to provide an estimate on the upper bound of how well we could expect cross-dataset models to perform.</li>
<li>Trained on <em>mibi data</em> using the intersecting features between mibi and the respective cytof dataset, with the <em>“ground truth” labels</em>, used to predict cell types in the cytof dataset (no labels given). <img src="imgs/rf/model1.png" style="width:20.0%">
</li>
<li>Trained on the <em>cytof data</em> using the same set of features as model 1, with the <em>predicted labels</em> generated from the first model, treating them as “ground truth” for the purposes of model building. <img src="imgs/rf/model2.png" style="width:20.0%">
</li>
</ol>
<p>We then use the second model to predict labels for the mibi dataset (dotted arrow in the schematic diagram). These predictions, when compared with the actual labels, provide a view into the robustness of shared structure in the data with respect to the defined groups.</p>
<p><img src="imgs/rf/recoverlabels.png" style="width:40.0%"></p>
</div>
<div id="set-up" class="section level1">
<h1 class="hasAnchor">
<a href="#set-up" class="anchor"></a>Set-up</h1>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">corral</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">SingleCellExperiment</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">scater</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggthemes</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">pals</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">caret</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">randomForest</span>)</pre></body></html></div>
<p>Make sure that you download the hackathon data files and add them to the <code>data</code> folder.</p>
<p>Download data here: <a href="https://drive.google.com/open?id=1Qb6VgVkWfy2x5Dr7kzqMAfzOLas1G6v-" class="uri">https://drive.google.com/open?id=1Qb6VgVkWfy2x5Dr7kzqMAfzOLas1G6v-</a></p>
<p>Read more about the datasets and the challenge: <a href="https://github.com/BIRSBiointegration/Hackathon/tree/master/sc-targeted-proteomics" class="uri">https://github.com/BIRSBiointegration/Hackathon/tree/master/sc-targeted-proteomics</a></p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">'../data/mibiSCE.rda'</span>)
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">'../data/masstagSCE.rda'</span>)</pre></body></html></div>
<p>Some of the protein names don’t match exactly between the two batches. To correct this, we will re-map them. We also normalize the expression values between 0 and 1 to correct differences in scale between the datasets.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">datnames</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'mibi'</span>,<span class="st">'livecells'</span>,<span class="st">'tcell'</span>,<span class="st">'cd45'</span>,<span class="st">'myeloid'</span>,<span class="st">'epith'</span>)

<span class="no">map_from</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'HLADR'</span>, <span class="st">'FOXP3'</span>, <span class="st">'HLA-DR'</span>,<span class="st">'CD279 (PD_1)'</span>, <span class="st">'CD274 (PD_L1)'</span>, <span class="st">'CD8a'</span>,<span class="st">'PD-L1'</span>)
<span class="no">map_to</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'HLA_DR'</span>, <span class="st">'FoxP3'</span>, <span class="st">'HLA_DR'</span>, <span class="st">'PD1'</span>, <span class="st">'PD_L1'</span>, <span class="st">'CD8'</span>,<span class="st">'PD_L1'</span>)

<span class="kw">for</span>(<span class="no">dn</span> <span class="kw">in</span> <span class="no">datnames</span>){
  <span class="no">objn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">dn</span>,<span class="st">'.sce'</span>)
  <span class="no">sce</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span>(<span class="no">objn</span>))
  <span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="fu">assay</span>(<span class="no">sce</span>), <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">norm01</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>))
  <span class="fu">assay</span>(<span class="no">sce</span>) <span class="kw">&lt;-</span> <span class="no">mat</span>
  <span class="no">inds_map</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">map_from</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">sce</span>))
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">sce</span>) <span class="kw">&lt;-</span> <span class="kw pkg">plyr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">sce</span>),<span class="kw">from</span> <span class="kw">=</span> <span class="no">map_from</span>[<span class="no">inds_map</span>], <span class="kw">to</span> <span class="kw">=</span> <span class="no">map_to</span>[<span class="no">inds_map</span>])
  <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="no">objn</span>, <span class="no">sce</span>)
}

<span class="no">consolidated</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mibi.sce</span>)$<span class="no">tumor_group</span>
<span class="no">consolidated</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">consolidated</span> <span class="kw">==</span> <span class="st">"Immune"</span>)] <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mibi.sce</span>)$<span class="no">immune_group</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">consolidated</span> <span class="kw">==</span> <span class="st">"Immune"</span>)]
<span class="fu">colData</span>(<span class="no">mibi.sce</span>)$<span class="no">consolidated</span> <span class="kw">&lt;-</span> <span class="no">consolidated</span></pre></body></html></div>
</div>
<div id="rf-model-trained-on-mibi-data" class="section level1">
<h1 class="hasAnchor">
<a href="#rf-model-trained-on-mibi-data" class="anchor"></a>0. RF model trained on mibi data</h1>
<div id="setting-up-data-for-random-forest" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-data-for-random-forest" class="anchor"></a>Setting up data for random forest</h2>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">xprmat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">mibi.sce</span>)[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu">rowData</span>(<span class="no">mibi.sce</span>)$<span class="no">is_protein</span> <span class="kw">==</span> <span class="fl">1</span>),])
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">xprmat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">mibi.sce</span>)[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu">rowData</span>(<span class="no">mibi.sce</span>)$<span class="no">is_protein</span> <span class="kw">==</span> <span class="fl">1</span>)]

<span class="no">mibi_full</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu">colData</span>(<span class="no">mibi.sce</span>)[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'SampleID'</span>,<span class="st">'cellLabelInImage'</span>,<span class="st">'tumor_group'</span>,<span class="st">'immune_group'</span>)],
                   <span class="no">consolidated</span>,
                   <span class="no">xprmat</span>)[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">mibi.sce</span>$<span class="no">SampleID</span> <span class="kw">&lt;</span> <span class="fl">41</span>),]

<span class="no">mibi_dat</span> <span class="kw">&lt;-</span> <span class="no">mibi_full</span>[,<span class="fl">5</span>:<span class="fl">43</span>]
<span class="no">mibi_dat</span>$<span class="no">consolidated</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">mibi_dat</span>$<span class="no">consolidated</span>)</pre></body></html></div>
<p>picking train/test inds</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">2020</span>)

<span class="no">frac</span> <span class="kw">&lt;-</span> <span class="fl">.8</span>
<span class="no">train_inds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>), <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">frac</span> * <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>)), <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">test_inds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>), <span class="no">train_inds</span>)</pre></body></html></div>
</div>
<div id="building-basic-model" class="section level2">
<h2 class="hasAnchor">
<a href="#building-basic-model" class="anchor"></a>Building basic model</h2>
<p>including all features</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)

<span class="no">rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="no">consolidated</span> ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">mibi_dat</span>[<span class="no">train_inds</span>,],
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu">varImpPlot</span>(<span class="no">rf_mod</span>)

<span class="no">rf_imp</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">importance</span>(<span class="no">rf_mod</span>)
<span class="no">rf_imp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Variables</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_imp</span>), <span class="no">rf_imp</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">rf_imp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span>(<span class="no">Variables</span>, <span class="no">MeanDecreaseGini</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="no">MeanDecreaseGini</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span><span class="kw">=</span><span class="st">'identity'</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Variables'</span>, <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Relative Variable Importance'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>()</pre></body></html></div>
<p>predictions on holdout</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># predict the outcome on test set</span>
<span class="no">basic_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">rf_mod</span>, <span class="no">mibi_dat</span>[<span class="no">test_inds</span>,])

<span class="co"># compare predicted outcome and true outcome</span>
<span class="no">basic_rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">basic_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">mibi_dat</span>$<span class="no">consolidated</span>[<span class="no">test_inds</span>]))

<span class="no">rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">basic_rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">basic_rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)

<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="co"># setting correct predictions to 0 to increase contrast</span>
<span class="no">rf_cm_pct_contrast</span> <span class="kw">&lt;-</span> <span class="no">rf_cm_pct</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_pct_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'fill'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="no">rf_cm_contrast</span> <span class="kw">&lt;-</span> <span class="no">basic_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in number of cells'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">rf_cm_contrast</span>)), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percent across all errors\n(basically another way of looking at confusion matrix)'</span>)

<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="no">basic_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_withcorrect</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">basic_rf_cm</span>$<span class="no">table</span>),<span class="no">rf_cm_withcorrect</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">celltype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm_withcorrect</span>),<span class="no">rf_cm_withcorrect</span>), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'celltype'</span>)),
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">celltype</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of all predictions'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are reclassified as V1\n(basically another way of looking at confusion matrix)'</span>)</pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">basic_rf_cm</span>$<span class="no">byClass</span>),<span class="no">basic_rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Random forest on mibi prediction results on test'</span>)</pre></body></html></div>
</div>
</div>
<div id="rf-model-trained-on-mibi-data-1" class="section level1">
<h1 class="hasAnchor">
<a href="#rf-model-trained-on-mibi-data-1" class="anchor"></a>1. RF model trained on mibi data</h1>
<p><img src="imgs/rf/model1.png" style="width:80.0%"></p>
<div id="setting-up-data-for-random-forest-1" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-data-for-random-forest-1" class="anchor"></a>Setting up data for random forest</h2>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">tum_mibi_full</span> <span class="kw">&lt;-</span> <span class="no">mibi_full</span>

<span class="no">imm_mibi_full</span> <span class="kw">&lt;-</span> <span class="no">mibi_full</span>

<span class="no">tum_int_genes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">tum_mibi_full</span>), <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">livecells.sce</span>))

<span class="no">imm_int_genes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">imm_mibi_full</span>), <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">tcell.sce</span>))

<span class="no">to_keep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'SampleID'</span>,<span class="st">'cellLabelInImage'</span>,<span class="st">'tumor_group'</span>,<span class="st">'immune_group'</span>,<span class="st">'consolidated'</span>)

<span class="co"># tumor panel</span>
<span class="no">tum_mibi_full</span> <span class="kw">&lt;-</span> <span class="no">tum_mibi_full</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">to_keep</span>,<span class="no">tum_int_genes</span>)]
<span class="no">tum_mibi_dat</span> <span class="kw">&lt;-</span> <span class="no">tum_mibi_full</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'consolidated'</span>,<span class="no">tum_int_genes</span>)]

<span class="co"># immune panel</span>
<span class="no">imm_mibi_full</span> <span class="kw">&lt;-</span> <span class="no">imm_mibi_full</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">to_keep</span>,<span class="no">imm_int_genes</span>)]
<span class="no">imm_mibi_dat</span> <span class="kw">&lt;-</span> <span class="no">imm_mibi_full</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'consolidated'</span>,<span class="no">imm_int_genes</span>)]</pre></body></html></div>
<p>picking train/test inds</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">2020</span>)

<span class="no">frac</span> <span class="kw">&lt;-</span> <span class="fl">.8</span>
<span class="no">train_inds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>), <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">frac</span> * <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>)), <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">test_inds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mibi_full</span>), <span class="no">train_inds</span>)</pre></body></html></div>
</div>
<div id="building-basic-model-1" class="section level2">
<h2 class="hasAnchor">
<a href="#building-basic-model-1" class="anchor"></a>Building basic model</h2>
<p>including all features</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)

<span class="no">tum_rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">consolidated</span>) ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">tum_mibi_dat</span>[<span class="no">train_inds</span>,],
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu">varImpPlot</span>(<span class="no">tum_rf_mod</span>)

<span class="no">tum_rf_imp</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">importance</span>(<span class="no">tum_rf_mod</span>)
<span class="no">tum_rf_imp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Variables</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">tum_rf_imp</span>), <span class="no">tum_rf_imp</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">tum_rf_imp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span>(<span class="no">Variables</span>, <span class="no">MeanDecreaseGini</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="no">MeanDecreaseGini</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span><span class="kw">=</span><span class="st">'identity'</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Variables'</span>, <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Relative Variable Importance: tumor panel RF'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>()

<span class="no">imm_rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">consolidated</span>) ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">imm_mibi_dat</span>[<span class="no">train_inds</span>,],
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu">varImpPlot</span>(<span class="no">imm_rf_mod</span>)

<span class="no">imm_rf_imp</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">importance</span>(<span class="no">imm_rf_mod</span>)
<span class="no">imm_rf_imp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Variables</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">imm_rf_imp</span>), <span class="no">imm_rf_imp</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">imm_rf_imp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span>(<span class="no">Variables</span>, <span class="no">MeanDecreaseGini</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="no">MeanDecreaseGini</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span><span class="kw">=</span><span class="st">'identity'</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="st">'black'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">'Variables'</span>, <span class="kw">title</span> <span class="kw">=</span> <span class="st">'Relative Variable Importance: Immune panel RF'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>()</pre></body></html></div>
<p>predictions on holdout: tumor</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">tum_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tum_rf_mod</span>, <span class="no">tum_mibi_dat</span>[<span class="no">test_inds</span>,])

<span class="no">tum_rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">tum_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">tum_mibi_dat</span>$<span class="no">consolidated</span>[<span class="no">test_inds</span>]))

<span class="no">tum_rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">tum_rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">tum_rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)

<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">tum_rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Tumor panel RF model:'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'mibi on test'</span>) <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="co"># setting correct predictions to 0 to increase contrast</span>
<span class="no">rf_cm_pct_contrast</span> <span class="kw">&lt;-</span> <span class="no">rf_cm_pct</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_pct_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'fill'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: tumor'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: tumor'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="no">rf_cm_contrast</span> <span class="kw">&lt;-</span> <span class="no">tum_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: tumor'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in number of cells'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">rf_cm_contrast</span>)), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: tumor'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percent across all errors\n(basically another way of looking at confusion matrix)'</span>)

<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="no">tum_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_withcorrect</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">tum_rf_cm</span>$<span class="no">table</span>),<span class="no">rf_cm_withcorrect</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">celltype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm_withcorrect</span>),<span class="no">rf_cm_withcorrect</span>), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'celltype'</span>)),
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">celltype</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of all predictions: tumor'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are reclassified as V1\n(basically another way of looking at confusion matrix)'</span>)

<span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">tum_rf_cm</span>$<span class="no">byClass</span>),<span class="no">tum_rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Random forest on mibi prediction'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Results on test: tumor panel"</span>)</pre></body></html></div>
<p>predictions on holdout: immune</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">imm_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">imm_rf_mod</span>, <span class="no">imm_mibi_dat</span>[<span class="no">test_inds</span>,])

<span class="no">imm_rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">imm_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">imm_mibi_dat</span>$<span class="no">consolidated</span>[<span class="no">test_inds</span>]))

<span class="no">imm_rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">imm_rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">imm_rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)

<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">imm_rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Immune panel RF model:'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'mibi on test'</span>) <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="co"># setting correct predictions to 0 to increase contrast</span>
<span class="no">rf_cm_pct_contrast</span> <span class="kw">&lt;-</span> <span class="no">rf_cm_pct</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_pct_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'fill'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: immune'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: immune'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percentage within each cell type'</span>)

<span class="no">rf_cm_contrast</span> <span class="kw">&lt;-</span> <span class="no">imm_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_contrast</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: immune'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in number of cells'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_contrast</span>/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">rf_cm_contrast</span>)), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">Prediction</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of incorrect predictions: immune'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are removed\nvalue is in percent across all errors\n(basically another way of looking at confusion matrix)'</span>)

<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="no">imm_rf_cm</span>$<span class="no">table</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">rf_cm_withcorrect</span>) <span class="kw">&lt;-</span> <span class="fl">0</span>
<span class="no">rf_cm_withcorrect</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="no">imm_rf_cm</span>$<span class="no">table</span>),<span class="no">rf_cm_withcorrect</span>))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">celltype</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm_withcorrect</span>),<span class="no">rf_cm_withcorrect</span>), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'celltype'</span>)),
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">celltype</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">position</span> <span class="kw">=</span> <span class="st">'stack'</span>, <span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Distribution of all predictions: immune'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'correct predictions are reclassified as V1\n(basically another way of looking at confusion matrix)'</span>)

<span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Sensitivity'</span>, <span class="st">'Specificity'</span>,<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">imm_rf_cm</span>$<span class="no">byClass</span>),<span class="no">imm_rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">'Random forest on mibi prediction'</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Results on test: immune panel"</span>)</pre></body></html></div>
</div>
<div id="predictions-on-cytof" class="section level2">
<h2 class="hasAnchor">
<a href="#predictions-on-cytof" class="anchor"></a>Predictions on cytof</h2>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co"># TUMOR</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ComplexHeatmap</span>)

<span class="no">livecells_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tum_rf_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">livecells.sce</span>)[<span class="no">tum_int_genes</span>,]))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">livecells_rf_pred</span>)

<span class="no">livecells_ct_expr_rf</span> <span class="kw">&lt;-</span> <span class="fu">find_ct_expr</span>(<span class="fu">assay</span>(<span class="no">livecells.sce</span>), <span class="no">livecells_rf_pred</span>)
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(<span class="no">livecells_ct_expr_rf</span>, <span class="kw">name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'livecells'</span>,<span class="st">'_cytof\navg expr by mibi proj celltypes'</span>),
     <span class="kw">clustering_distance_rows</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_rows</span> <span class="kw">=</span> <span class="st">'average'</span>,
     <span class="kw">clustering_distance_columns</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_columns</span> <span class="kw">=</span> <span class="st">'average'</span>)

<span class="no">epith_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tum_rf_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">epith.sce</span>)[<span class="no">tum_int_genes</span>,]))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">epith_rf_pred</span>)

<span class="no">epith_ct_expr_rf</span> <span class="kw">&lt;-</span> <span class="fu">find_ct_expr</span>(<span class="fu">assay</span>(<span class="no">epith.sce</span>), <span class="no">epith_rf_pred</span>)
<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/show-dispatch.html">show</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(<span class="no">epith_ct_expr_rf</span>, <span class="kw">name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'epith'</span>,<span class="st">'_cytof\navg expr by mibi proj celltypes'</span>),
     <span class="kw">clustering_distance_rows</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_rows</span> <span class="kw">=</span> <span class="st">'average'</span>,
     <span class="kw">clustering_distance_columns</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_columns</span> <span class="kw">=</span> <span class="st">'average'</span>))

<span class="co"># IMMUNE</span>

<span class="co"># recoding to accommodate rf</span>

<span class="no">imm_scelist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">tcell</span> <span class="kw">=</span> <span class="no">tcell.sce</span>,
                    <span class="kw">cd45</span> <span class="kw">=</span> <span class="no">cd45.sce</span>,
                    <span class="kw">myeloid</span> <span class="kw">=</span> <span class="no">myeloid.sce</span>,
                    <span class="kw">mibi</span> <span class="kw">=</span> <span class="no">mibi.sce</span>)

<span class="no">imm_ct_expr_rf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="no">imm_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()

<span class="kw">for</span> (<span class="no">imm</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">imm_scelist</span>)){
  <span class="no">rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">imm_rf_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="no">imm</span>]])[<span class="no">imm_int_genes</span>,]))
  <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">rf_pred</span>)
  <span class="no">imm_preds</span><span class="kw">[[</span><span class="no">imm</span>]] <span class="kw">&lt;-</span> <span class="no">rf_pred</span>

  <span class="no">imm_ct_expr_rf</span><span class="kw">[[</span><span class="no">imm</span>]] <span class="kw">&lt;-</span> <span class="fu">find_ct_expr</span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="no">imm</span>]]), <span class="no">rf_pred</span>)
  <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/show-dispatch.html">show</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(<span class="no">imm_ct_expr_rf</span><span class="kw">[[</span><span class="no">imm</span>]], <span class="kw">name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">imm</span>,<span class="st">'_cytof\navg expr by mibi proj celltypes'</span>),
     <span class="kw">clustering_distance_rows</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_rows</span> <span class="kw">=</span> <span class="st">'average'</span>,
     <span class="kw">clustering_distance_columns</span> <span class="kw">=</span> <span class="st">'spearman'</span>, <span class="kw">clustering_method_columns</span> <span class="kw">=</span> <span class="st">'average'</span>))
}</pre></body></html></div>
</div>
</div>
<div id="rf-model-trained-on-cytof-using-predicted-labels" class="section level1">
<h1 class="hasAnchor">
<a href="#rf-model-trained-on-cytof-using-predicted-labels" class="anchor"></a>2. RF model trained on cytof (using predicted labels)</h1>
<p><img src="imgs/rf/model2.png" style="width:80.0%"></p>
<p>To validate the cytof predictions, building models to try to recover mibi cell types</p>
<div id="livecells-model-tumor-panel" class="section level2">
<h2 class="hasAnchor">
<a href="#livecells-model-tumor-panel" class="anchor"></a>livecells model [tumor panel]</h2>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">94010</span>)

<span class="no">livecells_rf_dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">livecells_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">livecells.sce</span>)[<span class="no">tum_int_genes</span>,])))
<span class="no">livecells_rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>(<span class="no">livecells_rf_pred</span>) ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">livecells_rf_dat</span>,
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">mibi_lc_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">livecells_rf_mod</span>, <span class="no">tum_mibi_full</span>[,<span class="no">tum_int_genes</span>])
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi_lc_rf_pred</span>)</pre></body></html></div>
</div>
<div id="recovering-mibi-tumor-cell-types-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#recovering-mibi-tumor-cell-types-performance" class="anchor"></a>Recovering mibi tumor cell types: performance</h2>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">correct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">tum_mibi_dat</span>$<span class="no">consolidated</span>)
<span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_lc_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>)) <span class="co">#EDIT ME</span>
<span class="no">tum_or_im</span> <span class="kw">&lt;-</span> <span class="st">'Tumor'</span><span class="co"># EDIT ME</span>


<span class="no">rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">predictions</span>, <span class="no">correct</span>)
<span class="no">rf_cm</span>

<span class="no">rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)
<span class="no">rf_cm_pct</span>

<span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">tum_or_im</span>,<span class="st">' panel RF model:'</span>), <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'cytof on mibi'</span>)<span class="co">#+ scale_fill_viridis_b()</span>
<span class="no">gg</span>

<span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm</span>$<span class="no">byClass</span>),<span class="no">rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Random forest on cytof's mibi prediction"</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Results on test: "</span>, <span class="no">tum_or_im</span>, <span class="st">" panel"</span>))</pre></body></html></div>
</div>
<div id="cd45-model-immune-panel" class="section level2">
<h2 class="hasAnchor">
<a href="#cd45-model-immune-panel" class="anchor"></a>cd45 model [immune panel]</h2>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">321</span>)

<span class="no">cd45_rf_dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">pred_ct</span> <span class="kw">=</span> <span class="no">imm_preds</span><span class="kw">[[</span><span class="st">'cd45'</span>]], <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="st">'cd45'</span>]])[<span class="no">imm_int_genes</span>,])))
<span class="no">cd45_rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>(<span class="no">pred_ct</span>) ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">cd45_rf_dat</span>,
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">mibi_cd45_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">cd45_rf_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="st">'mibi'</span>]])[<span class="no">imm_int_genes</span>,]))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi_cd45_rf_pred</span>)</pre></body></html></div>
</div>
<div id="tcellmyeloid-model-immune-panel" class="section level2">
<h2 class="hasAnchor">
<a href="#tcellmyeloid-model-immune-panel" class="anchor"></a>tcell+myeloid model [immune panel]</h2>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">321</span>)

<span class="no">train_inds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">imm_preds</span><span class="kw">[[</span><span class="st">'tcell'</span>]]), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">imm_preds</span><span class="kw">[[</span><span class="st">'myeloid'</span>]])),<span class="fl">500000</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

<span class="no">tc_m_rf_dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">pred_ct</span> <span class="kw">=</span> <span class="no">imm_preds</span><span class="kw">[[</span><span class="st">'tcell'</span>]], <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="st">'tcell'</span>]])[<span class="no">imm_int_genes</span>,]))),
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">pred_ct</span> <span class="kw">=</span> <span class="no">imm_preds</span><span class="kw">[[</span><span class="st">'myeloid'</span>]], <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="st">'myeloid'</span>]])[<span class="no">imm_int_genes</span>,]))))

<span class="no">tc_m_rf_mod</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForest</span><span class="kw ns">::</span><span class="fu">randomForest</span>(<span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>(<span class="no">pred_ct</span>) ~ <span class="no">.</span>,
                <span class="kw">data</span> <span class="kw">=</span> <span class="no">tc_m_rf_dat</span>[<span class="no">train_inds</span>,],
                <span class="kw">ntree</span> <span class="kw">=</span> <span class="fl">100</span>,
                <span class="kw">importance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">mibi_tc_m_rf_pred</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tc_m_rf_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu">assay</span>(<span class="no">imm_scelist</span><span class="kw">[[</span><span class="st">'mibi'</span>]])[<span class="no">imm_int_genes</span>,]))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi_tc_m_rf_pred</span>)</pre></body></html></div>
</div>
</div>
<div id="assessing-robustness-ability-to-recover-cell-types" class="section level1">
<h1 class="hasAnchor">
<a href="#assessing-robustness-ability-to-recover-cell-types" class="anchor"></a>Assessing robustness &amp; ability to recover cell types</h1>
<p><img src="imgs/rf/recoverlabels.png" style="width:80.0%"></p>
<div id="recovering-mibi-cell-types-with-cd45-rf" class="section level2">
<h2 class="hasAnchor">
<a href="#recovering-mibi-cell-types-with-cd45-rf" class="anchor"></a>Recovering mibi cell types with cd45 rf</h2>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">correct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">consolidated</span>)
<span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_cd45_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>)) <span class="co">#EDIT ME</span>
<span class="no">tum_or_im</span> <span class="kw">&lt;-</span> <span class="st">'Immune (CD45)'</span><span class="co"># EDIT ME</span>


<span class="no">rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">predictions</span>, <span class="no">correct</span>)
<span class="no">rf_cm</span>

<span class="no">rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)
<span class="no">rf_cm_pct</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">tum_or_im</span>,<span class="st">' panel RF model:'</span>), <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'cytof on mibi'</span>)<span class="co">#+ scale_fill_viridis_b()</span>


<span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm</span>$<span class="no">byClass</span>),<span class="no">rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Random forest on cytof's mibi prediction"</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Results on test: "</span>, <span class="no">tum_or_im</span>, <span class="st">" panel"</span>))</pre></body></html></div>
</div>
<div id="recovering-mibi-cell-types-with-tcm-rf" class="section level2">
<h2 class="hasAnchor">
<a href="#recovering-mibi-cell-types-with-tcm-rf" class="anchor"></a>Recovering mibi cell types with tc+m rf</h2>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">correct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">consolidated</span>)
<span class="no">predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_tc_m_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>)) <span class="co">#EDIT ME</span>
<span class="no">tum_or_im</span> <span class="kw">&lt;-</span> <span class="st">'Immune (TC + M)'</span><span class="co"># EDIT ME</span>


<span class="no">rf_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">predictions</span>, <span class="no">correct</span>)
<span class="no">rf_cm</span>

<span class="no">rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)
<span class="no">rf_cm_pct</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">tum_or_im</span>,<span class="st">' panel RF model:'</span>), <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'cytof on mibi'</span>)<span class="co">#+ scale_fill_viridis_b()</span>


<span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm</span>$<span class="no">byClass</span>),<span class="no">rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Random forest on cytof's mibi prediction"</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Results on test: "</span>, <span class="no">tum_or_im</span>, <span class="st">" panel"</span>))

<span class="no">plots_from_cm</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">rf_cm</span>, <span class="no">title</span>, <span class="no">subtitle</span>){
  <span class="no">rf_cm_pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>,<span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>,<span class="kw">STATS</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(<span class="no">rf_cm</span>$<span class="no">table</span>),<span class="kw">FUN</span> <span class="kw">=</span> <span class="st">'/'</span>)
  <span class="no">rf_cm_pct</span>

  <span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="no">rf_cm_pct</span>), <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">Prediction</span>, <span class="no">Reference</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">value</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">tum_or_im</span>,<span class="st">' panel RF model:'</span>), <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">'cytof on mibi'</span>)<span class="co">#+ scale_fill_viridis_b()</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/show-dispatch.html">show</a></span>(<span class="no">gg</span>)
  <span class="no">tokeep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Precision'</span>,<span class="st">'Recall'</span>,<span class="st">'Balanced Accuracy'</span>)

  <span class="no">gg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu">melt</span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">rf_cm</span>$<span class="no">byClass</span>),<span class="no">rf_cm</span>$<span class="no">byClass</span>[,<span class="no">tokeep</span>]), <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'class'</span>)),
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="no">value</span>, <span class="no">class</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">variable</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(<span class="kw">stat</span> <span class="kw">=</span> <span class="st">'identity'</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>()) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="no">title</span>, <span class="kw">subtitle</span> <span class="kw">=</span> <span class="no">subtitle</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/show-dispatch.html">show</a></span>(<span class="no">gg</span>)
}</pre></body></html></div>
<p>Comparison of classifications from: tumor (livecells), cd45, tc+m</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">correct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">consolidated</span>)
<span class="no">tcm_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_tc_m_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>))
<span class="no">cd45_preds</span><span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_cd45_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>))

<span class="no">tcm_cd45_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">tcm_preds</span>, <span class="no">cd45_preds</span>)
<span class="fu">plots_from_cm</span>(<span class="no">tcm_cd45_cm</span>,<span class="st">'CD45 vs Tc+M model cross-comparison'</span>,<span class="st">'predicting mibi'</span>)

<span class="no">correct_tum</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">tum_mibi_dat</span>$<span class="no">consolidated</span>)
<span class="no">tum_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">mibi_lc_rf_pred</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span>(<span class="no">correct</span>))
<span class="no">tcm_tum_cm</span> <span class="kw">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="no">tcm_preds</span>, <span class="no">tum_preds</span>)
<span class="fu">plots_from_cm</span>(<span class="no">tcm_tum_cm</span>,<span class="st">'Tumor vs Tc+M model cross-comparison'</span>,<span class="st">'predicting mibi'</span>)</pre></body></html></div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Harvard School of Public Health<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lauren Hsu, Aedin Culhane.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
